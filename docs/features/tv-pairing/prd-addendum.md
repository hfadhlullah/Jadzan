# PRD Addendum — TV Pairing Flow

| Metadata | Details |
| :--- | :--- |
| **Feature** | TV Pairing Flow |
| **Parent Epic** | CORE |
| **Status** | Ready for Development |
| **Stories** | JADZ-012, JADZ-013, JADZ-014, JADZ-015 |

---

## 1. Feature Overview

The TV Pairing Flow enables a Mosque Admin to link a physical Android TV device to their Mosque account. On first boot, the TV displays a unique 6-digit code. The Admin enters this code in the Web Dashboard to activate the screen. Once paired, the TV receives its `screen_id` and begins fetching content.

---

## 2. User Stories

| ID | Story | Acceptance Criteria (Given-When-Then) |
| :--- | :--- | :--- |
| US-01 | As a TV App on first boot, I generate and display a unique 6-digit pairing code so the Admin can activate me. | **Given** there is no `screenId` in AsyncStorage, **When** the pairing screen loads, **Then** a unique 6-digit code is generated and displayed prominently. |
| US-02 | As a Mosque Admin, I can enter the TV's pairing code in the dashboard to link it to my Mosque. | **Given** I am logged in and navigate to Screens → Add Screen, **When** I enter a valid code and a screen name and submit, **Then** the screen is linked to my mosque and appears in my screen list. |
| US-03 | As a Mosque Admin, I can name a screen (e.g., "Women's Hall") so I can identify it later. | **Given** I am pairing a new screen, **When** I enter name "Main Hall" alongside the code, **Then** `screens.name` = "Main Hall" is persisted. |
| US-04 | As a TV App, after being paired, I receive a confirmation and transition to the Main Display screen. | **Given** the Admin has entered the pairing code, **When** the backend activates the screen, **Then** the TV automatically navigates from PairingScreen to MainDisplay within 30 seconds. |

---

## 3. ERD Delta

None. Uses the existing `screens` table from `JADZ-001`:
- `pairing_code` — generated by TV, stored temporarily.
- `mosque_id` — set by Admin during pairing.
- `status` — changes from `PENDING` → `ACTIVE` on successful pair.

---

## 4. Pairing Flow Diagram

```
[TV — First Boot]
       │
       ├─ Check AsyncStorage for screenId
       │       │
       │    NULL → Generate CODE (6-digit alphanumeric)
       │              │
       │         INSERT screens row: { pairing_code: CODE, status: PENDING }
       │              │
       │         Display: "Go to [URL] and enter code: CODE"
       │              │
       │         Poll every 5s: screens.status == 'ACTIVE'?
       │
[Admin — Web Dashboard]
       │
       ├─ Navigate to /dashboard/screens → "Add Screen"
       │
       ├─ Enter CODE + Screen Name → Submit
       │
       ├─ Server Action: validatePairCode(CODE, mosqueId, screenName)
       │       ├─ Find screen by pairing_code
       │       ├─ UPDATE screens SET mosque_id, name, status='ACTIVE'
       │       └─ Return success
       │
[TV — Polling detects ACTIVE]
       │
       └─ Save screenId to AsyncStorage → Navigate to MainDisplay
```

---

## 5. Integration Notes

- **Polling interval**: TV polls `screens` table every **5 seconds** during the pairing phase only. After activation, polling stops.
- **Code Expiry**: Pairing codes do not expire in MVP (simplicity). Post-MVP: 24h TTL.
- **Security**: `pairing_code` is unique — Supabase unique index enforced. Admin can only link screens to *their own* mosque (RLS enforced).
